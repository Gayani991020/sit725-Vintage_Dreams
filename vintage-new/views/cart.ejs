<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Vintage-Dreams</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" type="text/css" href="../css/util.css" />
    <link rel="stylesheet" type="text/css" href="../css/main.css" />
  </head>
  <body>
    <div>
      <nav class="navbar navbar-expand-lg bg-light">
        <div class="container-fluid">
          <a class="navbar-brand" href="/index.html">Vintage-Dreams</a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item">
                <a class="nav-link" href="/">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/user/account">My Account</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/user/cart"
                  >My Cart
                  <span class="badge text-bg-info"
                    ><%= cart?.items?.length %></span
                  ></a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/user/whishlist"
                  >My Wishlist <span class="badge text-bg-info"><%= wishlist?.items?.length %></span></a
                >
              </li>
            </ul>
            <div>
              <a class="btn btn-outline-dark" href="/login">Login/Logout</a>
            </div>
          </div>
        </div>
      </nav>
    </div>
    <div class="w-100 p-5 py-2 pt-4">
      <h3>My Cart</h3>
    </div>
    <div class="container-fluid">
      <div class="p-3">
        <form class="bg0 p-t-75 p-b-85">
          <div class="container">
            <div class="row">
              <div class="col-lg-10 col-xl-7 m-lr-auto m-b-50">
                <div class="m-l-25 m-r--38 m-lr-0-xl">
                  <div class="wrap-table-shopping-cart">
                    <table class="table-shopping-cart">
                      <tr class="table_head">
                        <th class="column-1">Product</th>
                        <th class="column-2"></th>
                        <th class="column-3">Price</th>
                        <th class="column-4">Quantity</th>
                        <th class="column-5">Total</th>
                      </tr>

                      <% if (cart?.items != null) { %> <% var total = 0;
                      cart.items.forEach(function(item) { %>
                      <tr class="table_row" data-product-id="<%= item._id %>">
                        <td class="column-1">
                          <div class="how-itemcart1">
                            <img
                              src="<%= (item.product.photo != '' && item.product.photo != null ) ? '/uploads/products/' + item.product.photo : '/assets/images/img-not-found.png' %>"
                              alt="IMG"
                            />
                          </div>
                        </td>
                        <td class="column-2"><%= item.product.name %></td>
                        <td class="column-3">$<%= item.price %></td>
                        <td class="column-4">
                          <input
                            class="form-control item-qty"
                            type="number"
                            name="num-product1"
                            data-product-id="<%= item._id %>"
                            value="<%= item.quantity %>"
                          />
                        </td>
                        <td class="column-5">
                          $<%= item.quantity * item.price %>
                        </td>
                      </tr>
                      <% total += (item.quantity * item.price); }) %> <% } %>
                    </table>
                  </div>

                  <div
                    class="flex-w flex-sb-m bor15 p-t-18 p-b-15 p-lr-40 p-lr-15-sm"
                  >
                    <div
                      id="update_cart_btn"
                      class="flex-c-m stext-101 cl0 size-119 bg1 bor13 hov-btn3 p-lr-15 trans-04 pointer m-tb-10"
                    >
                      Update Cart
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-sm-10 col-lg-7 col-xl-5 m-lr-auto m-b-50">
                <div
                  class="bor10 p-lr-40 p-t-30 p-b-40 m-l-63 m-r-40 m-lr-0-xl p-lr-15-sm"
                >
                  <h4
                    data-cart-id="<%= cart._id %>"
                    class="mtext-109 cl2 p-b-30"
                  >
                    Cart Totals
                  </h4>

                  <div class="flex-w flex-t bor12 p-b-13">
                    <div class="size-208">
                      <span class="stext-110 cl2"> Total: </span>
                    </div>

                    <div class="size-209">
                      <span class="mtext-110 cl2"> $<%= total %> </span>
                    </div>
                  </div>

                  <div class="flex-w flex-t bor12 p-t-15 p-b-30">
                    <div class="w-full">
                      <span class="stext-110 cl2"> Shipping Address </span>
                    </div>
                    <div class="bor8 bg0 m-b-12 m-t-8 w-full">
                      <input
                        class="stext-111 cl8 plh3 size-111 w-100 p-lr-15"
                        type="text"
                        name="address"
                        id="address"
                        placeholder="Address"
                        value="<%= user.address %>"
                      />
                    </div>
                    <div class="w-full">
                      <span class="stext-110 cl2"> Telephone </span>
                    </div>
                    <div class="bor8 bg0 m-b-12 m-t-8 w-full">
                      <input
                        class="stext-111 cl8 plh3 size-111 w-100 p-lr-15"
                        type="text"
                        name="telephone"
                        id="telephone"
                        placeholder="Telephone Number"
                        value="<%= user.telephone %>"
                      />
                    </div>
                  </div>
                  <div class="flex-w flex-t bor12 p-t-15 p-b-30">
                    <div class="w-full">
                      <span class="stext-110 cl2"> Payment Type </span>
                    </div>
                    <div>
                      <div
                        class="bg0 m-b-12 m-t-4 w-full"
                        style="display: flex; flex-direction: row"
                      >
                        <input
                          class=""
                          style="margin-right: 10px"
                          type="radio"
                          name="pType"
                          id="pType-card"
                          placeholder="Address"
                          value="1"
                          checked
                        />
                        <label>Card</label>
                      </div>
                      <div
                        class="bg0 m-b-12 m-t-8 w-full"
                        style="display: flex; flex-direction: row"
                      >
                        <input
                          class=""
                          style="margin-right: 10px"
                          type="radio"
                          name="pType"
                          id="pType-cash"
                          placeholder="Address"
                          value="2"
                        />
                        <label>Cash On Delivery</label>
                      </div>
                    </div>
                  </div>
                  <div
                    id="card_details_div"
                    class="flex-w flex-t bor12 p-t-15 p-b-30"
                  >
                    <div class="w-full" style="margin-bottom: 15px">
                      <h5><strong>Card Details</strong></h5>
                    </div>
                    <div class="w-full">
                      <span class="stext-110 cl2"> Card Number </span>
                    </div>
                    <div class="bor8 bg0 m-b-12 m-t-8 w-full">
                      <input
                        class="stext-111 cl8 plh3 size-111 w-100 p-lr-15"
                        type="text"
                        name="card_number"
                        id="card_number"
                        placeholder="Enter card number"
                        value=""
                      />
                    </div>
                    <div class="w-full">
                      <span class="stext-110 cl2"> Expiry Date </span>
                    </div>
                    <div class="bor8 bg0 m-b-12 m-t-8 w-full">
                      <input
                        class="stext-111 cl8 plh3 size-111 w-100 p-lr-15"
                        type="text"
                        name="exp_date"
                        id="exp_date"
                        placeholder="MM/YY"
                        value=""
                      />
                    </div>
                    <div class="w-full">
                      <span class="stext-110 cl2"> CVV </span>
                    </div>
                    <div class="bor8 bg0 m-b-12 m-t-8 w-full">
                      <input
                        class="stext-111 cl8 plh3 size-111 w-100 p-lr-15"
                        type="text"
                        name="cvv"
                        id="cvv"
                        placeholder="CVV ex: 123"
                        value=""
                      />
                    </div>
                  </div>

                  <button
                    id="place_order_btn"
                    class="flex-c-m stext-101 cl0 size-116 bg3 bor14 hov-btn3 m-t-12 p-lr-15 trans-04 pointer"
                  >
                    Place Order
                  </button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
      crossorigin="anonymous"
    ></script>
    <script src="../assets/jquery.min.js"></script>
    <script src="../assets/sweetalert2@11.js"></script>
    <script>
      // on document ready
      $(document).ready(function () {
        // on form submit
        $("#update_cart_btn").click(function (e) {
          // prevent default form submission
          e.preventDefault();

          // get the form data
          var formData = {
            items: [],
          };

          // get all the items in the cart
          $(".table_row").each(function () {
            var productId = $(this).data("product-id");
            var quantity = $(this).find(".item-qty").val();

            formData.items.push({
              itemId: productId,
              quantity: quantity,
            });
          });

          // make ajax request
          $.ajax({
            url: "/cart/updateCart",
            type: "POST",
            data: JSON.stringify(formData),
            contentType: "application/json",
            success: function (data) {
              if (data.status == 200) {
                // show success message
                Swal.fire({
                  title: "Success!",
                  text: "Cart updated successfully!",
                  icon: "success",
                  confirmButtonText: "OK",
                }).then((result) => {
                  // Reload the Page
                  location.reload();
                });
              } else {
                // show error message
                Swal.fire({
                  title: "Error!",
                  text: "Something went wrong!",
                  icon: "error",
                  confirmButtonText: "OK",
                });
              }
            },
            error: function (err) {
              // show error message
              Swal.fire({
                title: "Error!",
                text: "Something went wrong!",
                icon: "error",
                confirmButtonText: "OK",
              });
            },
          });
        });

        // on payment type change
        $("#pType-card").change(function () {
          $("#card_details_div").show();
        });
        $("#pType-cash").change(function () {
          $("#card_details_div").hide();
        });

        // on place order button click
        $("#place_order_btn").click(function (e) {
          // prevent default form submission
          e.preventDefault();

          // get the form data
          var formData = {
            cartId: $(".mtext-109").data("cart-id"),
            shippingAddress: $("#address").val(),
            telephone: $("#telephone").val(),
            paymentMethod: $("input[name='pType']:checked").val(),
            cardNumber: $("#card_number").val(),
            cardExpiry: $("#exp_date").val(),
            cardCVV: $("#cvv").val(),
          };

          // make ajax request
          $.ajax({
            url: "/order",
            type: "POST",
            data: JSON.stringify(formData),
            contentType: "application/json",
            success: function (data) {
              if (data.status == 201) {
                // show success message
                Swal.fire({
                  title: "Success!",
                  text: "Order placed successfully!",
                  icon: "success",
                  confirmButtonText: "OK",
                }).then((result) => {
                  // Redirect to my orders page
                  window.location.href = "/user/account";
                });
              } else {
                // show error message
                Swal.fire({
                  title: "Error!",
                  text: data.message || "Something went wrong!",
                  icon: "error",
                  confirmButtonText: "OK",
                });
              }
            },
            error: function (err) {
              // show error message
              Swal.fire({
                title: "Error!",
                text: "Something went wrong!",
                icon: "error",
                confirmButtonText: "OK",
              });
            },
          });
        });
      });
    </script>
  </body>
</html>
